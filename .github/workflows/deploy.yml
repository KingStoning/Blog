name: Deploy to BT (build on GitHub)

on:
  push:
    branches: ["main"]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22.15.0"

      # 用 corepack 按 package.json 的 packageManager 自动装 pnpm（避免版本冲突）
      - name: Enable corepack + install pnpm
        run: |
          corepack enable
          corepack install

      - name: Install deps
        run: pnpm i --frozen-lockfile

      - name: Generate
        run: pnpm generate

      # 打印输出目录，避免你再遇到 “dist 不存在”
      - name: Debug output directories
        run: |
          echo "==== workspace root ===="
          pwd
          ls -la
          echo ""
          echo "==== dist ===="
          ls -la dist || true
          echo ""
          echo "==== .output ===="
          ls -la .output || true
          echo ""
          echo "==== .output/public ===="
          ls -la .output/public || true

      # 先默认用 .output/public（Nuxt SSG 常见输出）
      # 如果你 Debug 里发现实际是 dist，就把下面 path 改成 dist/
      - name: Deploy to VPS
        uses: burnett01/rsync-deployments@7.0.1
        with:
          switches: -avzr --delete
          path: .output/public/
          remote_path: ${{ secrets.VPS_PATH }}
          remote_host: ${{ secrets.VPS_HOST }}
          remote_user: ${{ secrets.VPS_USER }}
          remote_port: ${{ secrets.VPS_PORT }}
          remote_key: ${{ secrets.VPS_SSH_KEY }}
